<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PTZ Camera Control</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }
    
    .app-container {
      display: grid;
      grid-template-columns: 1fr 1fr 320px;
      gap: 16px;
      height: 100vh;
      padding: 16px;
    }

    @media (max-width: 1400px) {
      .app-container { grid-template-columns: 1fr 1fr; }
      .settings-panel { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    }

    @media (max-width: 800px) {
      .app-container { grid-template-columns: 1fr; }
    }
    
    .panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-title {
      font-size: 13px;
      font-weight: 700;
      color: #06b6d4;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .video-panel { grid-column: 1; }
    .video-container {
      background: #000;
      border: 1px solid #0f4a5c;
      border-radius: 6px;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 12px;
      min-height: 400px;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .video-placeholder {
      position: absolute;
      text-align: center;
      color: #64748b;
    }

    .stream-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    input[type="text"], input[type="url"], input[type="number"], select, input[type="range"] {
      padding: 8px 10px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 4px;
      color: #e2e8f0;
      font-size: 12px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    button {
      padding: 8px 12px;
      background: #06b6d4;
      color: #0f172a;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: #00d9ff;
    }

    button.secondary {
      background: #334155;
      color: #e2e8f0;
    }

    button.secondary:hover {
      background: #475569;
    }
    
    .ptz-panel {
      grid-column: 2;
      display: flex;
      flex-direction: column;
    }

    .joystick-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      flex: 1;
      min-height: 400px;
    }

    #joystick {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, #0f172a 0%, #0a0f1a 100%);
      border: 2px solid #06b6d4;
      border-radius: 50%;
      position: relative;
      cursor: grab;
      user-select: none;
      box-shadow: 0 0 30px rgba(6, 182, 212, 0.3);
      touch-action: none;
    }

    #joystick:active {
      cursor: grabbing;
      box-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
    }

    .joystick-center {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #06b6d4;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
    }

    .joystick-ring {
      position: absolute;
      width: 70%;
      height: 70%;
      border: 1px dashed rgba(6, 182, 212, 0.2);
      border-radius: 50%;
      top: 15%;
      left: 15%;
    }

    #joystickKnob {
      width: 48px;
      height: 48px;
      background: radial-gradient(circle, #00d9ff 0%, #06b6d4 100%);
      border: 2px solid #00d9ff;
      border-radius: 50%;
      position: absolute;
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.8);
      top: 96px;
      left: 96px;
      z-index: 10;
    }

    .joystick-stats {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      border-radius: 4px;
      padding: 10px;
      margin-top: 12px;
      font-family: monospace;
      font-size: 11px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }

    .stat-label { color: #94a3b8; font-weight: 600; }
    .stat-value { color: #06b6d4; font-weight: bold; }

    .speed-control {
      margin-top: 12px;
      padding: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      border-radius: 4px;
    }

    .speed-label {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    input[type="range"] {
      width: 100%;
      cursor: pointer;
    }

    .ptz-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 12px;
    }

    .ptz-btn {
      padding: 10px !important;
      font-size: 11px !important;
      background: #334155 !important;
      color: #e2e8f0 !important;
    }

    .ptz-btn:hover {
      background: #475569 !important;
    }

    .settings-panel {
      grid-column: 3;
      max-height: 100vh;
      overflow-y: auto;
    }

    .settings-section {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid #334155;
      border-radius: 4px;
    }

    .settings-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #06b6d4;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .setting-item {
      margin-bottom: 8px;
    }

    .setting-label {
      font-size: 10px;
      color: #94a3b8;
      margin-bottom: 3px;
      display: block;
      font-weight: 500;
    }

    .setting-item input,
    .setting-item select {
      width: 100%;
    }

    .port-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 6px;
      margin-bottom: 6px;
    }

    .port-row input {
      width: 100%;
    }

    .button-group {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .button-group button {
      flex: 1;
    }

    .status-msg {
      font-size: 11px;
      margin-top: 6px;
      padding: 6px;
      border-radius: 3px;
      text-align: center;
    }

    .success { background: rgba(33, 128, 141, 0.2); color: #06b6d4; border: 1px solid #06b6d4; }
    .error { background: rgba(192, 21, 47, 0.2); color: #ff6b6b; border: 1px solid #c01530; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Video -->
    <div class="panel video-panel">
      <div class="panel-title">Live Stream</div>
      <div class="video-container">
        <video id="videoPreview" autoplay muted playsinline></video>
        <div class="video-placeholder" id="videoPlaceholder">
          <div>No stream active</div>
          <div style="font-size: 10px; color: #475569; margin-top: 4px;">Configure and load below</div>
        </div>
      </div>
      <div class="stream-controls">
        <input id="streamUrl" type="url" placeholder="rtsp://192.168.1.11:554/1/h264major" value="rtsp://192.168.1.11:554/1/h264major" style="flex: 1;">
        <button onclick="loadStream()">Load</button>
      </div>
      <div style="font-size: 11px; color: #94a3b8; padding: 8px; background: rgba(15,23,42,0.5); border-radius: 4px;" id="videoStatus">Ready</div>
    </div>

    <!-- PTZ -->
    <div class="panel ptz-panel">
      <div class="panel-title">PTZ Control</div>
      
      <div class="joystick-wrapper">
        <div id="joystick">
          <div class="joystick-ring"></div>
          <div class="joystick-center"></div>
          <div id="joystickKnob"></div>
        </div>
      </div>

      <div class="joystick-stats">
        <div class="stat-row"><span class="stat-label">Pan:</span><span class="stat-value" id="panValue">0.00</span></div>
        <div class="stat-row"><span class="stat-label">Tilt:</span><span class="stat-value" id="tiltValue">0.00</span></div>
        <div class="stat-row"><span class="stat-label">Zoom:</span><span class="stat-value" id="zoomValue">1.0x</span></div>
      </div>

      <div class="speed-control">
        <div class="speed-label">
          <span>Speed</span>
          <span id="speedValue">50%</span>
        </div>
        <input type="range" id="speedSlider" min="10" max="100" value="50" step="10" onchange="updateSpeed()">
      </div>

      <div class="ptz-buttons">
        <button class="ptz-btn" onmousedown="startCmd('left')" onmouseup="stopCmd()" ontouchstart="startCmd('left')" ontouchend="stopCmd()">Pan L</button>
        <button class="ptz-btn" onmousedown="startCmd('up')" onmouseup="stopCmd()" ontouchstart="startCmd('up')" ontouchend="stopCmd()">Tilt U</button>
        <button class="ptz-btn" onmousedown="startCmd('right')" onmouseup="stopCmd()" ontouchstart="startCmd('right')" ontouchend="stopCmd()">Pan R</button>
        <button class="ptz-btn" onmousedown="startCmd('down')" onmouseup="stopCmd()" ontouchstart="startCmd('down')" ontouchend="stopCmd()">Tilt D</button>
        <button class="ptz-btn" onmousedown="startCmd('zoomin')" onmouseup="stopCmd()" ontouchstart="startCmd('zoomin')" ontouchend="stopCmd()">Zoom In</button>
        <button class="ptz-btn" onmousedown="startCmd('zoomout')" onmouseup="stopCmd()" ontouchstart="startCmd('zoomout')" ontouchend="stopCmd()">Zoom Out</button>
        <button class="ptz-btn" onclick="quickCmd('focus')">Auto Focus</button>
        <button class="ptz-btn" onclick="quickCmd('home')">Home</button>
      </div>
    </div>

    <!-- Settings -->
    <div class="settings-panel">
      <div class="panel-title">Camera Config</div>

      <div class="settings-section">
        <div class="settings-section-title">Connection</div>
        <div class="setting-item">
          <label class="setting-label">IP Address</label>
          <input id="cameraIP" type="text" value="192.168.1.11">
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Ports</div>
        <div class="port-row">
          <div><label class="setting-label">HTTP</label><input id="httpPort" type="number" value="81" min="1"></div>
          <div><label class="setting-label">RTSP</label><input id="rtspPort" type="number" value="554" min="1"></div>
        </div>
        <div class="port-row">
          <div><label class="setting-label">ONVIF</label><input id="onvifPort" type="number" value="2000" min="1"></div>
          <div><label class="setting-label">VISCA</label><input id="viscaPort" type="number" value="52381" min="1"></div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Auth</div>
        <div class="setting-item">
          <label class="setting-label">Username</label>
          <input id="cameraUser" type="text" placeholder="admin">
        </div>
        <div class="setting-item">
          <label class="setting-label">Password</label>
          <input id="cameraPass" type="text" placeholder="password">
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section-title">Protocol</div>
        <div class="setting-item">
          <label class="setting-label">Control</label>
          <select id="controlProtocol">
            <option value="http">HTTP API</option>
            <option value="onvif">ONVIF</option>
            <option value="visca">VISCA</option>
          </select>
        </div>
        <div class="setting-item">
          <label class="setting-label">Stream</label>
          <select id="streamPath">
            <option value="/1/h264major">H264 Main</option>
            <option value="/1/h264minor">H264 Sub</option>
          </select>
        </div>
      </div>

      <div class="button-group">
        <button onclick="testConnection()">Test</button>
        <button class="secondary" onclick="saveSettings()">Save</button>
      </div>
      <div id="statusMessage"></div>
    </div>
  </div>

  <script>
    let state = {
      pan: 0, tilt: 0, zoom: 1,
      isDragging: false,
      speed: 0.5,
      cmdLoop: null,
      currentCmd: null,
      config: {
        ip: '192.168.1.11',
        httpPort: 81,
        rtspPort: 554,
        onvifPort: 2000,
        viscaPort: 52381,
        protocol: 'http'
      }
    };

    const joystick = document.getElementById('joystick');
    const knob = document.getElementById('joystickKnob');
    const maxR = 90;
    const cX = 120, cY = 120;

    // Smooth joystick input
    function startDrag(e) {
      state.isDragging = true;
      updateJoystick(e);
    }

    function moveDrag(e) {
      if (state.isDragging) updateJoystick(e);
    }

    function endDrag() {
      state.isDragging = false;
      state.pan = 0;
      state.tilt = 0;
      knob.style.transform = 'translate(-24px, -24px)';
      knob.style.top = '96px';
      knob.style.left = '96px';
      updateDisplay();
    }

    function updateJoystick(e) {
      const rect = joystick.getBoundingClientRect();
      const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left - cX;
      const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top - cY;
      const d = Math.sqrt(x*x + y*y);
      let px = x, py = y;

      if (d > maxR) {
        px = (x/d) * maxR;
        py = (y/d) * maxR;
      }

      knob.style.left = (cX + px - 24) + 'px';
      knob.style.top = (cY + py - 24) + 'px';
      state.pan = px / maxR;
      state.tilt = -py / maxR;
      updateDisplay();
      sendContinuous();
    }

    joystick.addEventListener('mousedown', startDrag);
    joystick.addEventListener('touchstart', startDrag);
    document.addEventListener('mousemove', moveDrag);
    document.addEventListener('touchmove', moveDrag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);

    joystick.addEventListener('wheel', (e) => {
      e.preventDefault();
      state.zoom += e.deltaY > 0 ? -0.1 : 0.1;
      state.zoom = Math.max(1, Math.min(10, state.zoom));
      updateDisplay();
    });

    function updateSpeed() {
      state.speed = parseInt(document.getElementById('speedSlider').value) / 100;
      document.getElementById('speedValue').textContent = Math.round(state.speed * 100) + '%';
    }

    function updateDisplay() {
      document.getElementById('panValue').textContent = (state.pan * 100).toFixed(0);
      document.getElementById('tiltValue').textContent = (state.tilt * 100).toFixed(0);
      document.getElementById('zoomValue').textContent = state.zoom.toFixed(1) + 'x';
    }

    async function sendContinuous() {
      if (!state.isDragging) return;
      try {
        await fetch('/api/ptz', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pan: state.pan * state.speed,
            tilt: state.tilt * state.speed,
            zoom: state.zoom
          })
        });
      } catch (e) { }
    }

    function startCmd(cmd) {
      state.currentCmd = cmd;
      if (!state.cmdLoop) {
        state.cmdLoop = setInterval(() => {
          if (state.currentCmd) sendPTZ({ command: state.currentCmd });
        }, 100);
      }
    }

    function stopCmd() {
      state.currentCmd = null;
      if (state.cmdLoop) {
        clearInterval(state.cmdLoop);
        state.cmdLoop = null;
      }
    }

    async function quickCmd(cmd) {
      await sendPTZ({ command: cmd });
    }

    async function sendPTZ(data) {
      try {
        await fetch('/api/ptz', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } catch (e) { console.error(e); }
    }

    async function loadStream() {
      const url = document.getElementById('streamUrl').value;
      const video = document.getElementById('videoPreview');
      const status = document.getElementById('videoStatus');
      const ph = document.getElementById('videoPlaceholder');

      if (!url) { status.textContent = 'Enter URL'; return; }
      status.textContent = 'Connecting...';
      try {
        video.src = url;
        video.onloadstart = () => { ph.style.display = 'none'; status.textContent = 'Playing'; };
        video.onerror = () => { status.textContent = 'Error'; ph.style.display = 'block'; };
      } catch (e) { status.textContent = 'Error: ' + e.message; }
    }

    async function testConnection() {
      const msg = document.getElementById('statusMessage');
      msg.innerHTML = '<div class="status-msg">Testing...</div>';
      try {
        const r = await fetch('/api/camera/info');
        const d = await r.json();
        msg.innerHTML = d.status === 'ok' ? '<div class="status-msg success">Connected</div>' : '<div class="status-msg error">Offline</div>';
      } catch (e) {
        msg.innerHTML = '<div class="status-msg error">Failed: ' + e.message + '</div>';
      }
    }

    function saveSettings() {
      state.config = {
        ip: document.getElementById('cameraIP').value,
        httpPort: parseInt(document.getElementById('httpPort').value),
        rtspPort: parseInt(document.getElementById('rtspPort').value),
        onvifPort: parseInt(document.getElementById('onvifPort').value),
        viscaPort: parseInt(document.getElementById('viscaPort').value),
        user: document.getElementById('cameraUser').value,
        pass: document.getElementById('cameraPass').value,
        protocol: document.getElementById('controlProtocol').value
      };
      localStorage.setItem('ptzConfig', JSON.stringify(state.config));
      document.getElementById('statusMessage').innerHTML = '<div class="status-msg success">Saved</div>';
    }

    function loadSettings() {
      const saved = localStorage.getItem('ptzConfig');
      if (saved) {
        state.config = JSON.parse(saved);
        document.getElementById('cameraIP').value = state.config.ip;
        document.getElementById('httpPort').value = state.config.httpPort;
        document.getElementById('rtspPort').value = state.config.rtspPort;
        document.getElementById('onvifPort').value = state.config.onvifPort;
        document.getElementById('viscaPort').value = state.config.viscaPort;
        document.getElementById('cameraUser').value = state.config.user || '';
        document.getElementById('cameraPass').value = state.config.pass || '';
        document.getElementById('controlProtocol').value = state.config.protocol || 'http';
      }
    }

    updateSpeed();
    updateDisplay();
    loadSettings();
    console.log('PTZ ready');
  </script>
</body>
</html>
